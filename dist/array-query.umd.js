(function(u,l){typeof exports=="object"&&typeof module<"u"?l(exports):typeof define=="function"&&define.amd?define(["exports"],l):(u=typeof globalThis<"u"?globalThis:u||self,l(u["array-query"]={}))})(this,function(u){var m,x,g,E,T,N,$,v,S,y,s,P,B,J,C,A,R,f,p,O,k,d,q,M,W;"use strict";var D=(u,l,c)=>{if(!l.has(u))throw TypeError("Cannot "+c)};var e=(u,l,c)=>(D(u,l,"read from private field"),c?c.call(u):l.get(u)),a=(u,l,c)=>{if(l.has(u))throw TypeError("Cannot add the same private member more than once");l instanceof WeakSet?l.add(u):l.set(u,c)},o=(u,l,c,w)=>(D(u,l,"write to private field"),w?w.call(u,c):l.set(u,c),c);var h=(u,l,c)=>(D(u,l,"access private method"),c);const F=class{constructor(t){a(this,P);a(this,A);a(this,f);a(this,O);a(this,d);a(this,M);a(this,m,void 0);a(this,x,void 0);a(this,g,void 0);a(this,E,void 0);a(this,T,void 0);a(this,N,void 0);a(this,$,void 0);a(this,v,void 0);a(this,S,void 0);a(this,y,void 0);a(this,s,void 0);a(this,J,t=>{o(this,s,new w(t))});a(this,C,(t,r)=>(o(this,m,e(this,m)+t),r&&o(this,s,null),this));if(!(this instanceof F))return new F(t);t&&e(this,J).call(this,t),o(this,m,""),o(this,x,{}),o(this,g,[]),o(this,E,[]),o(this,T,[]),o(this,N,[])}on(t){return Promise.resolve(t).then(n=>{try{return h(this,P,B).call(this,n)}catch(i){return console.error(`An error occurred while performing array operations: ${i}`),[]}})}getFilter(){var r;const t=this.toString();return t?((r=e(this,S))==null?void 0:r.query)===t?e(this,S):(o(this,S,new Function("obj",`try { return ${t}  } catch (e) { return false; }`).bind(this)),e(this,S).query=t,e(this,S)):null}getSort(){if(!e(this,g).length)return null;if(e(this,y))return e(this,y);const t=e(this,g).map(r=>r.toFunction());return o(this,y,(r,n)=>{let i=0,j=0,K=t.length;for(;j<K&&i==0;)i=t[j++](r,n);return i})}getActions(){return e(this,E)??[]}toString(){return h(this,M,W).call(this),e(this,m)}and(t){return h(this,A,R).call(this,"&&",t)}or(t){return h(this,A,R).call(this,"||",t)}not(t){return e(this,s)&&(e(this,s).not=!e(this,s).not,t!==void 0&&(e(this,s).value=t)),this}equals(t){return h(this,f,p).call(this,"===",t)}is(t){return h(this,f,p).call(this,"===",t)}isnt(t){return this.not(),this.is(t)}within(t){const r={};for(const n in t)r[t[n]]=!0;return e(this,s)&&(e(this,s).template="%not%operator[%term]"),h(this,f,p).call(this,h(this,O,k).call(this,r))}has(t){return e(this,s)&&(e(this,s).template="%not(%term != null && %term.indexOf(%value) != -1)"),h(this,f,p).call(this,null,t)}startsWith(t){return e(this,s)&&(e(this,s).template="%not(%term != null && %term.substr(0, %operator) == %value)"),h(this,f,p).call(this,t.length,t)}endsWith(t){return e(this,s)&&(e(this,s).template="%not(%term != null && %term.substr(%term.length - %operator) == %value)"),h(this,f,p).call(this,t.length,t)}gt(t){return h(this,f,p).call(this,">",t)}gte(t){return h(this,f,p).call(this,">=",t)}lt(t){return h(this,f,p).call(this,"<",t)}lte(t){return h(this,f,p).call(this,"<=",t)}regex(t){return e(this,s)&&(e(this,s).template="%not(%term != null && %operator.test(%term))"),h(this,f,p).call(this,h(this,O,k).call(this,t))}same(t){return e(this,s)&&(e(this,s).template="%not(JSON.stringify(%term) %operator %value)"),t=JSON.stringify(t),h(this,f,p).call(this,"==",t)}filter(t){if(typeof t!="function")throw new Error("query.filter() parameter must be a function");return e(this,s)?e(this,s).template="%not(%operator(%term))":(o(this,s,new w),e(this,s).template="%not(%operator(obj))"),h(this,f,p).call(this,h(this,O,k).call(this,t))}search(t){t=H(t);const r=new RegExp("\\b"+t.split(/\s/).join("|\\b"));return this.regex(r)}type(t){return typeof t=="function"?(e(this,s)?e(this,s).template="%not(%term instanceof %operator)":(o(this,s,new w),e(this,s).template="%not(obj instanceof %operator)"),h(this,f,p).call(this,h(this,O,k).call(this,t))):(e(this,s)&&(e(this,s).template="%not(type(%term) %operator %value)"),h(this,f,p).call(this,"==",t))}sort(t){return e(this,y)&&o(this,y,null),e(this,g).push(new G(t)),this}asc(){return h(this,d,q).call(this,1)}desc(){return h(this,d,q).call(this,-1)}regular(){return h(this,d,q).call(this,"regular")}numeric(){return h(this,d,q).call(this,"numeric")}date(){return h(this,d,q).call(this,"date")}custom(t){return h(this,d,q).call(this,"custom",t)}limit(t){return o(this,v,t),this}offset(t){return o(this,$,t),this}set(t){return e(this,E).push(function(r){r.set(t)}),this}get lookups(){return e(this,x)}setExpression(t){o(this,s,t)}};let l=F;m=new WeakMap,x=new WeakMap,g=new WeakMap,E=new WeakMap,T=new WeakMap,N=new WeakMap,$=new WeakMap,v=new WeakMap,S=new WeakMap,y=new WeakMap,s=new WeakMap,P=new WeakSet,B=function(t){const r=this.getFilter(),n=this.getSort();let i=[...t];return r&&(i=i.filter(r,F)),n&&(i=i.sort(n)),e(this,$)?i=i.slice(e(this,$),e(this,$)+(e(this,v)||0)):e(this,v)&&(i=i.slice(0,e(this,v))),e(this,E).forEach(j=>{i.forEach(j)}),e(this,T).forEach(j=>{i=i.map(j)}),e(this,N).forEach(j=>{i=i.reduce(j)}),i},J=new WeakMap,C=new WeakMap,A=new WeakSet,R=function(t,r){return h(this,M,W).call(this),o(this,m,e(this,m)+` ${t} `),typeof r=="string"?o(this,s,new w(r)):r instanceof F?(Object.assign(e(this,x),e(r,x)),o(this,m,e(this,m)+`(${r})`)):r&&o(this,m,e(this,m)+`(${r})`),this},f=new WeakSet,p=function(t,r){return e(this,s)&&(e(this,s).operator=t,e(this,s).value=r),this},O=new WeakSet,k=function(t){const r=Math.round(Math.random()*1e6);return e(this,x)[r]=t,"this.lookups["+r+"]"},d=new WeakSet,q=function(t,r){if(e(this,g).length==0)return;e(this,y)&&o(this,y,null);const n=e(this,g)[e(this,g).length-1];return typeof t=="number"?n.direction=t:(n.type=n[t],r!==void 0&&(n.direction=r)),this},M=new WeakSet,W=function(){e(this,s)&&o(this,m,e(this,m)+e(this,s)),o(this,s,null)};class c extends l{constructor(t){if(!Array.isArray(t))throw new TypeError("Must query on an Array, but passed: "+t);if(!(this instanceof c))return new c(t);this.array=t}where(t){return t&&this.setExpression(new w(t)),this}end(){return this.on(this.array)}}class w{constructor(t,r,n,i){this.term=t,this.operator=r,this.value=n,this.not=i,this.template="%not(%term %operator %value)"}toString(){return this.template.replace(/%\w+/g,t=>{switch(t){case"%not":return this.not?"!":"";case"%term":return`
          ( 
            typeof obj["${this.term}"] !== "undefined" ? 
            obj["${this.term}"] : (typeof obj.get === "function" && obj.get("${this.term}"))
          )${this.value instanceof Date?".getTime()":""}
            `;case"%operator":return this.operator;case"%value":return JSON.stringify(this.value instanceof Date?this.value.getTime():this.value)}})}}class G{constructor(t,r,n){this.term=t,this.type=r||this.regular,this.direction=n||1}toFunction(){return this.type(this.term,this.direction)}regular(t,r){return function(n,i){return n=n[t],i=i[t],i==null?-1:n==null?1:r*(n>i?1:n<i?-1:0)}}numeric(t,r){return function(n,i){return n=parseFloat(n[t]),i=parseFloat(i[t]),i==null||isNaN(i)?-1:n==null||isNaN(n)?1:r*(n-i)}}date(t,r){return function(n,i){return n=n[t],i=i[t],i==null?-1:n==null?1:r*(n.getTime()-i.getTime())}}custom(t,r){return t?function(n,i){return r(n[t],i[t])}:function(n,i){return r(n,i)}}}function H(b){return b.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}const z=function(...b){return new l(...b)},I=function(...b){return new c(...b)};u.Query=z,u.Select=I,u.default=z,Object.defineProperties(u,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
